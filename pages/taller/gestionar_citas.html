<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Citas - Portal de Taller</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="../../style.css">
    <style>
        body {
            background-color: #202020;
        }

        .portal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            background-color: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .portal-header .logo {
            width: 120px;
        }

        .back-link {
            color: #c0c0c0;
            text-decoration: none;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: #f39c12;
        }

        .header-right {
            text-align: right;
        }

        .header-right h2 {
            margin: 0;
            font-size: 1.2em;
            color: #ffffff;
        }

        .header-right p {
            margin: 0;
            font-size: 0.9em;
            color: #a0a0a0;
        }

        .page-container {
            max-width: 1300px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-title {
            font-size: 2.2em;
            color: #ffffff;
            margin: 0;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            background-color: #3f3f3f;
            border: 1px solid #555;
            color: #f0f0f0;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background-color: #555;
        }

        .filter-btn.active {
            background-color: #f39c12;
            color: #1a1a1a;
            border-color: #f39c12;
        }

        .section-container {
            background-color: #2c2c2c;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.6em;
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .appointments-table-wrapper {
            overflow-x: auto;
        }

        .appointments-table {
            width: 100%;
            border-collapse: collapse;
        }

        .appointments-table th,
        .appointments-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #3f3f3f;
        }

        .appointments-table th {
            color: #a0a0a0;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .appointments-table td {
            color: #f0f0f0;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-Pendiente {
            background-color: #f39c12;
            color: white;
        }

        .status-Completado {
            background-color: #2ecc71;
            color: white;
        }

        .status-Cancelada {
            background-color: #e74c3c;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons .btn {
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
        }

        /* Estilos para el Modal de Detalles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: #2c2c2c;
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
            color: #ffffff;
        }

        .close-btn {
            background: none;
            border: none;
            color: #a0a0a0;
            font-size: 24px;
            cursor: pointer;
        }

        .detail-list {
            list-style: none;
            padding: 0;
        }

        .detail-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
        }

        .detail-list .label {
            color: #a0a0a0;
        }

        .detail-list .value {
            color: #ffffff;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <header class="portal-header">
        <div class="header-left">
            <a href="../../portal_taller.html"><img src="../../imagenes/Logo_Autoguest.png" alt="Logo de AutoGuest"
                    class="logo"></a>
            <a href="../../portal_taller.html" class="back-link"><i class="fas fa-arrow-left"></i> Volver al Panel</a>
        </div>
        <div class="header-right">
            <h2 id="tallerNameHeader">Nombre del Taller</h2>
            <p>Portal de Taller</p>
        </div>
    </header>

    <main class="page-container">
        <div class="page-header">
            <h1 class="page-title">Gestión de Citas</h1>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="Pendiente de Cotización">Pendientes</button>
                <button class="filter-btn" data-filter="Completado">Completadas</button>
                <button class="filter-btn" data-filter="Cancelada">Canceladas</button>
            </div>
        </div>

        <div class="section-container">
            <h2 class="section-title" id="tableTitle">Citas Pendientes</h2>
            <div class="appointments-table-wrapper">
                <table class="appointments-table" id="appointmentsTable">
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>Cliente</th>
                            <th>Vehículo</th>
                            <th>Mecánico</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsTableBody">
                        <!-- Las citas se cargarán aquí dinámicamente -->
                        <tr>
                            <td colspan="6">Cargando citas...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal de Detalles de Cita -->
    <div class="modal-overlay" id="detailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalles de la Cita</h2>
                <button class="close-btn" id="closeModalBtn">×</button>
            </div>
            <ul class="detail-list">
                <li><span class="label">Cliente:</span> <span class="value" id="modalCliente"></span></li>
                <li><span class="label">Email Cliente:</span> <span class="value" id="modalClienteEmail"></span></li>
                <li><span class="label">Vehículo:</span> <span class="value" id="modalVehiculo"></span></li>
                <li><span class="label">Placa:</span> <span class="value" id="modalPlaca"></span></li>
                <li><span class="label">Mecánico Asignado:</span> <span class="value" id="modalMecanico"></span></li>
                <li><span class="label">Fecha y Hora:</span> <span class="value" id="modalFecha"></span></li>
                <!DOCTYPE html>
                <html lang="es">

                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Gestionar Citas - Portal de Taller</title>
                    <link rel="stylesheet"
                        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
                    <link rel="stylesheet" href="../../style.css">
                    <style>
                        body {
                            background-color: #202020;
                        }

                        .portal-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 15px 40px;
                            background-color: #1a1a1a;
                            border-bottom: 1px solid #333;
                        }

                        .header-left {
                            display: flex;
                            align-items: center;
                            gap: 25px;
                        }

                        .portal-header .logo {
                            width: 120px;
                        }

                        .back-link {
                            color: #c0c0c0;
                            text-decoration: none;
                            font-size: 15px;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: color 0.3s ease;
                        }

                        .back-link:hover {
                            color: #f39c12;
                        }

                        .header-right {
                            text-align: right;
                        }

                        .header-right h2 {
                            margin: 0;
                            font-size: 1.2em;
                            color: #ffffff;
                        }

                        .header-right p {
                            margin: 0;
                            font-size: 0.9em;
                            color: #a0a0a0;
                        }

                        .page-container {
                            max-width: 1300px;
                            margin: 40px auto;
                            padding: 0 20px;
                        }

                        .page-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 30px;
                            flex-wrap: wrap;
                            gap: 20px;
                        }

                        .page-title {
                            font-size: 2.2em;
                            color: #ffffff;
                            margin: 0;
                        }

                        .filter-buttons {
                            display: flex;
                            gap: 10px;
                        }

                        .filter-btn {
                            background-color: #3f3f3f;
                            border: 1px solid #555;
                            color: #f0f0f0;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        }

                        .filter-btn:hover {
                            background-color: #555;
                        }

                        .filter-btn.active {
                            background-color: #f39c12;
                            color: #1a1a1a;
                            border-color: #f39c12;
                        }

                        .section-container {
                            background-color: #2c2c2c;
                            border-radius: 12px;
                            padding: 30px;
                            margin-bottom: 30px;
                        }

                        .section-title {
                            font-size: 1.6em;
                            color: #ffffff;
                            margin-top: 0;
                            margin-bottom: 20px;
                            padding-bottom: 10px;
                            border-bottom: 1px solid #444;
                        }

                        .appointments-table-wrapper {
                            overflow-x: auto;
                        }

                        .appointments-table {
                            width: 100%;
                            border-collapse: collapse;
                        }

                        .appointments-table th,
                        .appointments-table td {
                            padding: 15px;
                            text-align: left;
                            border-bottom: 1px solid #3f3f3f;
                        }

                        .appointments-table th {
                            color: #a0a0a0;
                            font-size: 0.9em;
                            text-transform: uppercase;
                        }

                        .appointments-table td {
                            color: #f0f0f0;
                        }

                        .status-badge {
                            padding: 5px 10px;
                            border-radius: 15px;
                            font-size: 0.8em;
                            font-weight: bold;
                        }

                        .status-Pendiente {
                            background-color: #f39c12;
                            color: white;
                        }

                        .status-Completado {
                            background-color: #2ecc71;
                            color: white;
                        }

                        .status-Cancelada {
                            background-color: #e74c3c;
                            color: white;
                        }

                        .action-buttons {
                            display: flex;
                            gap: 10px;
                        }

                        .action-buttons .btn {
                            padding: 8px 12px;
                            font-size: 14px;
                            width: auto;
                        }

                        /* Estilos para el Modal de Detalles */
                        .modal-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background-color: rgba(0, 0, 0, 0.7);
                            backdrop-filter: blur(5px);
                            display: none;
                            justify-content: center;
                            align-items: center;
                            z-index: 1000;
                        }

                        .modal-overlay.active {
                            display: flex;
                        }

                        .modal-content {
                            background-color: #2c2c2c;
                            padding: 30px;
                            border-radius: 12px;
                            width: 100%;
                            max-width: 500px;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                        }

                        .modal-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 20px;
                            border-bottom: 1px solid #444;
                            padding-bottom: 15px;
                        }

                        .modal-header h2 {
                            margin: 0;
                            font-size: 1.8em;
                            color: #ffffff;
                        }

                        .close-btn {
                            background: none;
                            border: none;
                            color: #a0a0a0;
                            font-size: 24px;
                            cursor: pointer;
                        }

                        .detail-list {
                            list-style: none;
                            padding: 0;
                        }

                        .detail-list li {
                            display: flex;
                            justify-content: space-between;
                            padding: 10px 0;
                        }

                        .detail-list .label {
                            color: #a0a0a0;
                        }

                        .detail-list .value {
                            color: #ffffff;
                            font-weight: 500;
                        }
                    </style>
                </head>

                <body>
                    <header class="portal-header">
                        <div class="header-left">
                            <a href="../../portal_taller.html"><img src="../../imagenes/Logo_Autoguest.png"
                                    alt="Logo de AutoGuest" class="logo"></a>
                            <a href="../../portal_taller.html" class="back-link"><i class="fas fa-arrow-left"></i>
                                Volver al Panel</a>
                        </div>
                        <div class="header-right">
                            <h2 id="tallerNameHeader">Nombre del Taller</h2>
                            <p>Portal de Taller</p>
                        </div>
                    </header>

                    <main class="page-container">
                        <div class="page-header">
                            <h1 class="page-title">Gestión de Citas</h1>
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="Pendiente">Pendientes</button>
                                <button class="filter-btn" data-filter="Completado">Completadas</button>
                                <button class="filter-btn" data-filter="Cancelada">Canceladas</button>
                            </div>
                        </div>

                        <div class="section-container">
                            <h2 class="section-title" id="tableTitle">Citas Pendientes</h2>
                            <div class="appointments-table-wrapper">
                                <table class="appointments-table" id="appointmentsTable">
                                    <thead>
                                        <tr>
                                            <th>Fecha y Hora</th>
                                            <th>Cliente</th>
                                            <th>Vehículo</th>
                                            <th>Mecánico</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="appointmentsTableBody">
                                        <!-- Las citas se cargarán aquí dinámicamente -->
                                        <tr>
                                            <td colspan="6">Cargando citas...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>

                    <!-- Modal de Detalles de Cita -->
                    <div class="modal-overlay" id="detailsModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>Detalles de la Cita</h2>
                                <button class="close-btn" id="closeModalBtn">×</button>
                            </div>
                            <ul class="detail-list">
                                <li><span class="label">Cliente:</span> <span class="value" id="modalCliente"></span>
                                </li>
                                <li><span class="label">Email Cliente:</span> <span class="value"
                                        id="modalClienteEmail"></span></li>
                                <li><span class="label">Vehículo:</span> <span class="value" id="modalVehiculo"></span>
                                </li>
                                <li><span class="label">Placa:</span> <span class="value" id="modalPlaca"></span></li>
                                <li><span class="label">Mecánico Asignado:</span> <span class="value"
                                        id="modalMecanico"></span></li>
                                <li><span class="label">Fecha y Hora:</span> <span class="value" id="modalFecha"></span>
                                </li>
                                <li><span class="label">Estado:</span> <span class="value" id="modalEstado"></span></li>
                            </ul>
                        </div>
                    </div>

                    <script>
                        document.addEventListener('DOMContentLoaded', async () => {
                            const tableBody = document.getElementById('appointmentsTableBody'); // Asegúrate que tu tbody tenga este ID
                            let mecanicos = [];

                            // 1. Cargar lista de mecánicos primero
                            try {
                                const resMec = await fetch('/api/taller/citas/mecanicos');
                                mecanicos = await resMec.json();
                            } catch (e) { console.error("Error cargando mecánicos"); }

                            // 2. Función para renderizar el select de mecánicos
                            const getMecanicoSelect = (idCita, idMecanicoActual) => {
                                let options = `<option value="">-- Sin Asignar --</option>`;
                                mecanicos.forEach(m => {
                                    const selected = m.idUsuario === idMecanicoActual ? 'selected' : '';
                                    options += `<option value="${m.idUsuario}" ${selected}>${m.nombre} (${m.especialidad})</option>`;
                                });
                                return `<select onchange="asignarMecanico('${idCita}', this.value)" class="form-control" style="padding: 5px; font-size: 0.9em;">
                    ${options}
                </select>`;
                            };

                            // 3. Cargar Citas
                            async function cargarCitas() {
                                try {
                                    const res = await fetch('/api/taller/citas');
                                    const citas = await res.json();

                                    tableBody.innerHTML = '';

                                    if (citas.length === 0) {
                                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center">No hay citas programadas.</td></tr>';
                                        return;
                                    }

                                    citas.forEach(cita => {
                                        const fecha = new Date(cita.fechaHora).toLocaleString();
                                        const row = `
                    <tr>
                        <td>${fecha}</td>
                        <td>${cita.clienteNombre}</td>
                        <td>${cita.marca} ${cita.modelo} (${cita.placa})</td>
                        <td>
                            ${getMecanicoSelect(cita.idCita, cita.idMecanico)}
                        </td>
                        <td><span class="status-badge status-${cita.estado.replace(/\s/g, '')}">${cita.estado}</span></td>
                        <td>
                            <button class="btn btn-sm" onclick="verDetalles('${cita.idCita}')">Detalles</button>
                        </td>
                    </tr>
                `;
                                        tableBody.innerHTML += row;
                                    });

                                } catch (error) {
                                    console.error(error);
                                    tableBody.innerHTML = '<tr><td colspan="6">Error de conexión.</td></tr>';
                                }
                            }

                            // 4. Función global para asignar mecánico (Se activa al cambiar el select)
                            window.asignarMecanico = async (idCita, idMecanico) => {
                                if (!idMecanico) return;

                                if (!confirm("¿Deseas asignar este mecánico a la cita? El cliente será notificado.")) return;

                                try {
                                    const res = await fetch(`/api/taller/citas/${idCita}/asignar`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ idMecanico })
                                    });
                                    const data = await res.json();

                                    if (res.ok) {
                                        alert("¡Mecánico asignado correctamente!");
                                        // Opcional: recargar para ver cambio de estado
                                        cargarCitas();
                                    } else {
                                        alert("Error: " + data.error);
                                    }
                                } catch (e) {
                                }
                            };

                            cargarCitas();
                        });
                    </script>
                    <script src="citas-admin.js"></script>`n
                </body>

                </html>