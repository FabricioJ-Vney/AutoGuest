<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat치logo de Productos - OM 66 Evolution</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <header>
        <div id="cart-icon-container">
            <span id="cart-icon">游</span>
            <span id="cart-count">0</span>
        </div>

        <h1>Cat치logo de Productos OM<sup>66</sup> Evolution</h1>
        <p>Calidad y rendimiento para tu veh칤culo.</p>
    </header>

    <main class="productos-container">
        <!-- Los productos se cargar치n aqu칤 din치micamente -->
        <p>Cargando productos...</p>
    </main>
    <footer>
        <h2>쯀nteresado en nuestros productos?</h2>
        <p>Cont치ctanos por WhatsApp para hacer tu pedido: <strong>+52 9991287457</strong></p>
        <p>&copy; 2023 Productos Automotrices OM 66.</p>
    </footer>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Tu Carrito de Compras</h2>
            <ul id="cart-items">
            </ul>
            <div id="cart-total-container">
                Total: $<span id="cart-total">0.00</span>
            </div>
            <button id="checkout-button">Finalizar Compra por WhatsApp</button>
        </div>
    </div>
    <div id="restock-modal" class="modal">
        <div class="modal-content">
            <span class="close-buttons-restock"
                style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            <h2>Reabastecer Producto</h2>
            <p id="restock-product-name"></p>
            <form id="restock-form">
                <input type="hidden" id="restock-product-id">
                <label for="restock-email">Email del Taller:</label>
                <input type="email" id="restock-email" required placeholder="correo@taller.com"
                    style="width: 100%; padding: 10px; margin-bottom: 10px;">

                <label for="restock-password">Contrase침a:</label>
                <input type="password" id="restock-password" required placeholder="********"
                    style="width: 100%; padding: 10px; margin-bottom: 10px;">

                <label for="restock-quantity">Cantidad a agregar:</label>
                <input type="number" id="restock-quantity" required min="1" value="10"
                    style="width: 100%; padding: 10px; margin-bottom: 20px;">

                <button type="submit"
                    style="width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; cursor: pointer;">Confirmar
                    Reabastecimiento</button>
            </form>
        </div>
    </div>

    <script src="js/cart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const productosContainer = document.querySelector('.productos-container');
            const restockModal = document.getElementById('restock-modal');
            const closeRestockBtn = document.querySelector('.close-buttons-restock');
            const restockForm = document.getElementById('restock-form');

            // Close modal events
            closeRestockBtn.onclick = () => restockModal.style.display = "none";
            window.onclick = (event) => {
                if (event.target == restockModal) {
                    restockModal.style.display = "none";
                }
            };

            async function loadProducts() {
                try {
                    const response = await fetch('/api/inventario');
                    const products = await response.json();

                    productosContainer.innerHTML = ''; // Clear existing content

                    products.forEach(product => {
                        const card = document.createElement('div');
                        card.className = 'producto-card';
                        card.dataset.id = product.id_producto;
                        card.dataset.precio = product.precio;
                        card.dataset.nombre = product.nombre;
                        card.dataset.stock = product.stock;

                        // Logic for stock display
                        const isSoldOut = product.stock <= 0;
                        const stockColor = isSoldOut ? 'red' : 'green';
                        const stockText = isSoldOut ? 'AGOTADO' : `Stock: ${product.stock}`;

                        const buttonText = isSoldOut ? 'Reabastecer (Taller)' : 'Agregar al Carrito';
                        // If sold out, button is enabled but triggers restock. If has stock, triggers add to cart.
                        const buttonClass = isSoldOut ? 'restock-btn' : 'add-to-cart';
                        const buttonStyle = isSoldOut ? 'background-color: #ff9800;' : '';

                        card.innerHTML = `
                            <img src="${product.imagen || 'img/default.jpg'}" alt="${product.nombre}">
                            <h2>${product.nombre}</h2>
                            <p>${product.descripcion}</p>
                            <div class="precio">
                                $${parseFloat(product.precio).toFixed(2)} 
                                <br>
                                <span style="font-size: 0.9em; color: ${stockColor}; font-weight: bold;">${stockText}</span>
                            </div>
                            <button class="${buttonClass}" style="${buttonStyle}">${buttonText}</button>
                        `;
                        productosContainer.appendChild(card);
                    });

                    attachEventListeners();

                } catch (error) {
                    console.error('Error al cargar los productos:', error);
                    productosContainer.innerHTML = '<p>Error al cargar los productos. Por favor, int칠ntalo de nuevo m치s tarde.</p>';
                }
            }

            function attachEventListeners() {
                // Add to Cart Buttons
                document.querySelectorAll('.add-to-cart').forEach(button => {
                    button.addEventListener('click', () => {
                        const card = button.closest('.producto-card');
                        const id = card.dataset.id;
                        const nombre = card.dataset.nombre;
                        const precio = parseFloat(card.dataset.precio);
                        const stock = parseInt(card.dataset.stock);
                        addItemToCart(id, nombre, precio, stock);
                    });
                });

                // Restock Buttons
                document.querySelectorAll('.restock-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const card = button.closest('.producto-card');
                        document.getElementById('restock-product-id').value = card.dataset.id;
                        document.getElementById('restock-product-name').innerText = `Reabasteciendo: ${card.dataset.nombre}`;
                        restockModal.style.display = "block";
                    });
                });
            }

            // Handle Restock Form Submit
            restockForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('restock-product-id').value;
                const email = document.getElementById('restock-email').value;
                const password = document.getElementById('restock-password').value;
                const cantidad = document.getElementById('restock-quantity').value;

                try {
                    const response = await fetch(`/api/inventario/${id}/restock`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password, cantidad: parseInt(cantidad) })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(result.mensaje);
                        restockModal.style.display = "none";
                        restockForm.reset();
                        loadProducts(); // Refresh list to update stock
                    } else {
                        alert('Error: ' + result.mensaje);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error de conexi칩n al intentar reabastecer.');
                }
            });

            // Initial Load
            loadProducts();
        });
    </script>
</body>

</html>