<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Vehículos - AutoGuest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="../../style.css">
    <style>
        /* --- ESTILOS PARA LA CABECERA MEJORADA --- */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            background-color: #2c2c2c;
            border-radius: 12px;
            margin-bottom: 40px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .dashboard-header .logo {
            width: 110px;
            display: block;
        }

        .back-to-dashboard {
            color: #c0c0c0;
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }

        .back-to-dashboard:hover {
            color: #f39c12;
        }

        .back-to-dashboard i {
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-right .user-greeting {
            font-size: 1.1em;
            color: #c0c0c0;
        }

        .header-right .logout-btn {
            background-color: transparent;
            color: #f39c12;
            border: 1px solid #f39c12;
            padding: 10px 20px;
            font-size: 14px;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .header-right .logout-btn:hover {
            background-color: #f39c12;
            color: #1a1a1a;
        }

        .page-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .page-header h1 {
            font-size: 2.8em;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .page-header p {
            font-size: 1.1em;
            color: #c0c0c0;
            max-width: 600px;
            margin: 0 auto;
        }

        .vehicles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 30px;
        }

        .vehicle-card,
        .add-vehicle-card {
            background-color: #2c2c2c;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border-left: 5px solid #f39c12;
            transition: transform 0.3s ease;
        }

        .vehicle-card:hover {
            transform: translateY(-5px);
        }

        .vehicle-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .vehicle-card-header h3 {
            font-size: 1.6em;
            color: #ffffff;
            margin: 0;
        }

        .vehicle-card-header .vehicle-icon {
            font-size: 2.5em;
            color: #f39c12;
        }

        .vehicle-details p {
            display: flex;
            justify-content: space-between;
            font-size: 1em;
            color: #e0e0e0;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #3a3a3a;
        }

        .vehicle-details p:last-child {
            border-bottom: none;
        }

        .vehicle-details p strong {
            color: #a0a0a0;
        }

        .vehicle-actions {
            margin-top: 25px;
            display: flex;
            gap: 15px;
        }

        .vehicle-actions .btn {
            font-size: 14px;
            padding: 10px 15px;
            flex: 1;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
            border: 1px solid #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .add-vehicle-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border: 2px dashed #555;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 5px solid #555;
            min-height: 290px;
        }

        .add-vehicle-card:hover {
            border-color: #f39c12;
            background-color: #333;
        }

        .add-vehicle-card .add-icon {
            font-size: 3em;
            color: #f39c12;
            margin-bottom: 15px;
        }

        .add-vehicle-card h3 {
            font-size: 1.5em;
            color: #ffffff;
            margin: 0;
        }

        /* Estilos para el Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: #2c2c2c;
            padding: 40px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            animation: zoomIn 0.3s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.95);
            }

            to {
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
            color: #ffffff;
        }

        .close-button {
            background: none;
            border: none;
            color: #a0a0a0;
            font-size: 28px;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
            padding: 0;
        }

        .close-button:hover {
            color: #f39c12;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .header-left {
                justify-content: space-between;
            }

            .back-to-dashboard span {
                display: none;
            }

            .header-right {
                justify-content: space-between;
            }
        }
    </style>
</head>

<body>

    <header class="dashboard-header">
        <div class="header-left">
            <a href="dashboard_cliente.html">
                <img src="../../imagenes/Logo_Autoguest.png" alt="Logo de AutoGuest" class="logo">
            </a>
            <a href="dashboard_cliente.html" class="back-to-dashboard">
                <i class="fas fa-arrow-left"></i>
                <span>Volver al Panel</span>
            </a>
        </div>
        <div class="header-right">
            <div class="user-greeting">¡Hola, [Nombre del Cliente]!</div>
            <a href="../../index.html" class="logout-btn">Cerrar Sesión</a>
        </div>
    </header>

    <main class="page-container">
        <div class="page-header">
            <h1>Mis Vehículos</h1>
            <p>Aquí puedes ver, editar o añadir todos los vehículos asociados a tu cuenta.</p>
        </div>

        <div class="vehicles-grid" id="vehiclesGrid">
            <!-- Tarjetas de vehículos se cargarán dinámicamente -->

            <!-- Tarjeta para añadir un nuevo vehículo -->
            <div class="add-vehicle-card" id="addVehicleBtn">
                <i class="fas fa-plus add-icon"></i>
                <h3>Añadir Nuevo Vehículo</h3>
            </div>
        </div>
    </main>

    <!-- Modal para añadir/editar vehículo -->
    <div class="modal-overlay" id="addVehicleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Añadir un Nuevo Vehículo</h2>
                <button class="close-button" id="closeModalBtn">×</button>
            </div>
            <form id="addVehicleForm">
                <div class="form-group">
                    <label for="modal-brand">Marca</label>
                    <input type="text" id="modal-brand" class="form-control" placeholder="Ej: Honda" required>
                </div>
                <div class="form-group">
                    <label for="modal-model">Modelo</label>
                    <input type="text" id="modal-model" class="form-control" placeholder="Ej: Civic" required>
                </div>
                <div class="form-group">
                    <label for="modal-year">Año</label>
                    <input type="number" id="modal-year" class="form-control" placeholder="Ej: 2023" min="1900"
                        max="2025" required>
                </div>
                <div class="form-group">
                    <label for="modal-plate">Matrícula / Placa</label>
                    <input type="text" id="modal-plate" class="form-control" placeholder="Ej: ABC-123"
                        pattern="[A-Z]{3}-[0-9]{3}"
                        title="Formato requerido: 3 letras mayúsculas, guión, 3 números (Ej: ABC-123)" maxlength="7"
                        style="text-transform: uppercase;" required>
                    <small style="color: #a0a0a0; font-size: 0.85em; margin-top: 5px; display: block;">
                        Formato: 3 letras-3 números (Ej: ABC-123)
                    </small>
                </div>
                <button type="submit" class="btn">Guardar Vehículo</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- INICIO: Guardián de Autenticación y Personalización ---
            if (sessionStorage.getItem('isLoggedIn') !== 'true') {
                alert('Tu sesión ha expirado. Por favor, inicia sesión de nuevo.');
                window.location.href = '../../login_cliente.html';
                return;
            }

            const userName = sessionStorage.getItem('userName');
            if (userName) {
                document.querySelector('.header-right .user-greeting').textContent = `¡Hola, ${userName}!`;
            }

            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        const response = await fetch('/api/registro/logout', { method: 'POST' });
                        if (response.ok) {
                            sessionStorage.clear();
                            window.location.href = '../../index.html';
                        } else {
                            alert('Error al cerrar sesión.');
                        }
                    } catch (error) {
                        alert('Error de red al cerrar sesión.');
                    }
                });
            }
            // --- FIN: Guardián de Autenticación ---

            const addVehicleBtn = document.getElementById('addVehicleBtn');
            const addVehicleModal = document.getElementById('addVehicleModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const addVehicleForm = document.getElementById('addVehicleForm');
            const vehiclesGrid = document.getElementById('vehiclesGrid');

            let isEditing = false;
            let currentVehicleId = null;

            const openModal = (vehicle = null) => {
                addVehicleModal.classList.add('active');
                if (vehicle) {
                    isEditing = true;
                    currentVehicleId = vehicle.idVehiculo;
                    document.querySelector('.modal-header h2').textContent = 'Editar Vehículo';
                    document.querySelector('#addVehicleForm button').textContent = 'Actualizar Vehículo';

                    document.getElementById('modal-brand').value = vehicle.marca;
                    document.getElementById('modal-model').value = vehicle.modelo;
                    document.getElementById('modal-year').value = vehicle.anio;
                    document.getElementById('modal-plate').value = vehicle.placa;
                } else {
                    isEditing = false;
                    currentVehicleId = null;
                    document.querySelector('.modal-header h2').textContent = 'Añadir un Nuevo Vehículo';
                    document.querySelector('#addVehicleForm button').textContent = 'Guardar Vehículo';
                    addVehicleForm.reset();
                }
            };

            const closeModal = () => {
                addVehicleModal.classList.remove('active');
                addVehicleForm.reset();
                isEditing = false;
                currentVehicleId = null;
            };

            const renderVehicle = (vehicle) => {
                // Verificar si ya existe la tarjeta para actualizarla
                let vehicleCard = document.querySelector(`.vehicle-card[data-id="${vehicle.idVehiculo}"]`);

                if (!vehicleCard) {
                    vehicleCard = document.createElement('div');
                    vehicleCard.classList.add('vehicle-card');
                    vehicleCard.dataset.id = vehicle.idVehiculo;
                    vehiclesGrid.insertBefore(vehicleCard, addVehicleBtn);
                }

                vehicleCard.innerHTML = `
                    <div class="vehicle-card-header">
                        <h3>${vehicle.marca} ${vehicle.modelo}</h3>
                        <i class="fas fa-car-side vehicle-icon"></i>
                    </div>
                    <div class="vehicle-details">
                        <p><strong>Marca:</strong> <span>${vehicle.marca}</span></p>
                        <p><strong>Modelo:</strong> <span>${vehicle.modelo}</span></p>
                        <p><strong>Año:</strong> <span>${vehicle.anio}</span></p>
                        <p><strong>Matrícula:</strong> <span>${vehicle.placa}</span></p>
                    </div>
                    <div class="vehicle-actions">
                        <button class="btn btn-secondary edit-btn">Editar</button>
                        <button class="btn btn-danger delete-btn">Eliminar</button>
                    </div>
                `;

                // Añadir event listener para el botón de eliminar
                vehicleCard.querySelector('.delete-btn').addEventListener('click', async () => {
                    if (!confirm(`¿Estás seguro de que quieres eliminar el ${vehicle.marca} ${vehicle.modelo}?`)) {
                        return;
                    }
                    try {
                        const response = await fetch(`/api/vehiculos/${vehicle.idVehiculo}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            vehicleCard.remove();
                            alert('Vehículo eliminado con éxito.');
                        } else {
                            const error = await response.json();
                            alert(`Error al eliminar: ${error.mensaje}`);
                        }
                    } catch (err) {
                        alert('Error de red al intentar eliminar el vehículo.');
                    }
                });

                // Añadir event listener para el botón de editar
                vehicleCard.querySelector('.edit-btn').addEventListener('click', () => {
                    openModal(vehicle);
                });
            };

            const loadVehicles = async () => {
                // Limpiar vehículos existentes (excepto el botón de añadir)
                document.querySelectorAll('.vehicle-card').forEach(card => {
                    card.remove();
                });

                try {
                    const response = await fetch('/api/vehiculos');
                    if (response.status === 401) {
                        // Sesión expirada o no válida
                        alert('Tu sesión ha expirado. Por favor, inicia sesión de nuevo.');
                        sessionStorage.clear();
                        window.location.href = '../../login_cliente.html';
                        return;
                    }
                    if (!response.ok) {
                        throw new Error('No se pudieron cargar los vehículos.');
                    }
                    const vehicles = await response.json();
                    if (vehicles.length === 0) {
                        console.log('No se encontraron vehículos para este usuario.');
                    } else {
                        vehicles.forEach(renderVehicle);
                    }
                } catch (error) {
                    console.error('Error al cargar vehículos:', error);
                    alert('Hubo un problema al cargar tus vehículos. Inténtalo de nuevo más tarde.');
                }
            };

            addVehicleBtn.addEventListener('click', () => openModal());
            closeModalBtn.addEventListener('click', closeModal);
            addVehicleModal.addEventListener('click', (e) => {
                if (e.target === addVehicleModal) closeModal();
            });

            addVehicleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const vehicleData = {
                    marca: document.getElementById('modal-brand').value.trim(),
                    modelo: document.getElementById('modal-model').value.trim(),
                    anio: document.getElementById('modal-year').value,
                    placa: document.getElementById('modal-plate').value.trim()
                };

                try {
                    let url = '/api/vehiculos';
                    let method = 'POST';

                    if (isEditing) {
                        url = `/api/vehiculos/${currentVehicleId}`;
                        method = 'PUT';
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(vehicleData)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.mensaje || 'Error al guardar el vehículo.');
                    }

                    const result = await response.json();
                    // Si es edición, el backend devuelve {success: true, vehiculo: {...} }
                    // Si es creación, devuelve el objeto vehículo directamente
                    const savedVehicle = isEditing ? result.vehiculo : result;

                    renderVehicle(savedVehicle);
                    closeModal();
                    alert(isEditing ? 'Vehículo actualizado con éxito.' : `¡Vehículo "${savedVehicle.marca}" añadido con éxito!`);

                } catch (error) {
                    console.error('Error al guardar vehículo:', error);
                    alert(error.message);
                }
            });

            // Carga inicial de vehículos desde el backend
            loadVehicles();
        });
    </script>
</body>

</html>